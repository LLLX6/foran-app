<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ÙÙˆØ±Ø§Ù‹ - Ù…Ù†ØµØ© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©</title>

<!-- â­ PWA: Web Manifest (inline, Ù„Ø§ ØªØ­ØªØ§Ø¬ manifest.json Ø®Ø§Ø±Ø¬ÙŠ) -->
<meta name="theme-color" content="#18456e" />

<!-- Manifest Inline + ØªÙØ¹ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ -->
<script id="manifest-inline" type="application/manifest+json">
{
  "name": "ÙÙˆØ±Ø§Ù‹ - Ù…Ù†ØµØ© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©",
  "short_name": "ÙÙˆØ±Ø§Ù‹",
  "start_url": ".",
  "display": "standalone",
  "background_color": "#f8fafb",
  "theme_color": "#18456e",
  "icons": [
    {
      "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABg0lEQVR42mNgoAX4zwAB/l8w/M/QRlf2w2XlAD4jUJ9FYiWYmTSCBEvw2RaGZkA8Tl0jOAAKMES2AVrAHE+gfwQiEIAWwATsRWBLLwBl5DwD4/4HwAC2Qgfq1CkYhNoRDIzGLQIMJjACw3Ajyk9QnEq1DsC0Vdg0KjIJFMCjYFZsA0Mygo8UAxBU2kE/wES/AKwAxF5O5UJVA+JQBTTp4BlFFMQx/AnQWBnJAABfKgAXV+QwSAcR9S8CjKMkEN4gANMBADrj+v5KZckdSZCkQhZo/kp8CkLwo4v8GkGi3MZgwJQTiACZBkA8XqQAUStAeR6GYYALfNkOAaEx1DcAFRxQfDEgiMgAA4lYCSxAH4mVQ/3MMsJtDJMgeIGeAUGeQFODXQW7gdweIEcNQOiAXQAi1IZAAAhKcBe+8e93kAAAAASUVORK5CYII=",
      "sizes": "192x192",
      "type": "image/png"
    }
  ]
}
</script>
<link rel="manifest" href="data:application/manifest+json," id="manifest-link"/>
<script>
(function() {
  const manifestScript = document.getElementById('manifest-inline');
  if (manifestScript) {
    const manifestJson = encodeURIComponent(manifestScript.textContent.trim());
    document.getElementById('manifest-link').setAttribute('href', 'data:application/manifest+json,' + manifestJson);
  }
})();
</script>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    /* Ø¨Ù‚ÙŠØ© Ø§Ù„Ù€ CSS ... */
  :root {
    --primary: #18456e;
    --accent: #27bda5;
    --danger: #c0392b;
    --bg-light: #f8fafb;
    --bg-dark: #1b2536;
    --pie-colors: #27bda5,#ffd200,#ff6f00,#29b6f6,#c0392b,#9c27b0,#43a047,#ff9800,#8bc34a,#f44336;
  }
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Cairo', sans-serif;
    margin: 0; padding: 0;
    background: var(--bg-light);
    color: var(--primary);
    min-height: 100vh;
    transition: background 0.3s, color 0.3s;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  body.dark {
    background: var(--bg-dark);
    color: #fff;
  }
  /* Navbar/Brandbar */
  .brandbar {
    background: linear-gradient(90deg, var(--primary), var(--accent));
    color: #fff;
    font-size: 1.3rem;
    font-weight: 700;
    letter-spacing: 1.2px;
    padding: 15px 22px 12px 12px;
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 1100;
    box-shadow: 0 2.5px 18px #0002;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    direction: rtl;
  }
  /* Sidebar */
  .sidebar {
    background: linear-gradient(135deg, var(--primary), var(--accent));
    padding: 20px 10px 25px 5px;
    width: 220px;
    min-width: 200px;
    min-height: 100vh;
    box-shadow: 0 3px 15px #0001;
    position: fixed;
    top: 0;
    right: 0;
    display: flex;
    flex-direction: column;
    gap: 14px;
    z-index: 1200;
    transition: transform 0.3s ease;
  }
  .sidebar h1 {
    color: #fff;
    font-size: 1.25rem;
    margin: 0 0 18px;
    text-align: center;
    font-weight: 700;
  }
  .sidebar button, .sidebar .toggle-theme {
    background: transparent;
    border: none;
    color: #fff;
    font-size: 1.1rem;
    padding: 10px 7px;
    border-radius: 8px;
    cursor: pointer;
    text-align: right;
    transition: background 0.2s;
  }
  .sidebar button:hover, .sidebar .toggle-theme:hover {
    background: rgba(255,255,255,0.14);
  }
  .sidebar button.active {
    background: rgba(255,255,255,0.26);
    font-weight: 700;
  }
  .sidebar .toggle-theme {
    margin-top: auto;
  }
  /* Hamburger */
  .hamburger {
    position: fixed;
    top: 15px;
    right: 15px;
    width: 28px;
    height: 22px;
    display: none;
    flex-direction: column;
    justify-content: space-between;
    cursor: pointer;
    z-index: 1301;
  }
  .hamburger div {
    height: 3.5px;
    background-color: var(--primary);
    border-radius: 3px;
    transition: all 0.3s ease;
  }
  .hamburger.active div:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
  }
  .hamburger.active div:nth-child(2) {
    opacity: 0;
  }
  .hamburger.active div:nth-child(3) {
    transform: rotate(-45deg) translate(6px, -6px);
  }
  /* Overlay */
.overlay-nav {
    position: fixed;
    inset: 0;
    background: #0005;
    backdrop-filter: blur(4px); /* Ø§Ù„Ø¶Ø¨Ø§Ø¨ÙŠØ© */
    z-index: 1199;
    display: none;
    transition: background 0.2s;
}
.overlay-nav.active {
    display: block;
}
  /* Main content */
  .main {
    margin-right: 220px;
    padding: 80px 2vw 24px 2vw;
    max-width: 1100px;
    min-height: 100vh;
    transition: margin 0.3s ease;
  }
  /* Responsive */
  @media (max-width: 900px) {
    .sidebar {
      width: 240px;
      min-width: unset;
      height: 100vh;
      position: fixed;
      top: 0;
      right: 0;
      transform: translateX(100%);
      opacity: 0;
      pointer-events: none;
      box-shadow: -6px 0 28px #0005;
    }
    .sidebar.active {
      transform: translateX(0);
      opacity: 1;
      pointer-events: all;
      display: flex;
    }
    .hamburger {
      display: flex;
    }
    .overlay-nav {
      display: none;
    }
    .overlay-nav.active {
      display: block;
    }
    .main {
      margin-right: 0;
      padding: 80px 1rem 24px 1rem;
    }
  }
  /* Cards Grid */
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 16px 24px;
  }
  .section-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 3px 15px #0001;
    padding: 22px 10px 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 1.15em;
    font-weight: 700;
    cursor: pointer;
    border: 2px solid transparent;
    transition: border 0.2s, transform 0.15s;
    min-height: 110px;
    user-select: none;
  }
  .section-card:hover, .section-card:focus {
    border-color: var(--primary);
    outline: none;
    transform: scale(1.05);
  }
  .section-emoji {
    font-size: 2.5em;
    margin-bottom: 12px;
  }
  /* Provider Card */
  .provider-card {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 3px 13px #0002;
    padding: 14px 12px 14px;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 14px;
    transition: box-shadow 0.2s;
    cursor: default;
    user-select: none;
  }
  .provider-card:focus-within, .provider-card:hover {
    box-shadow: 0 6px 24px #0004;
  }
  body.dark .provider-card, body.dark .section-card {
    background: #222c;
    color: #fff;
  }
  .provider-emoji {
    font-size: 1.85em;
    margin-left: 8px;
  }
  .provider-info {
    flex: 1;
  }
  .provider-info .row {
    display: flex;
    gap: 10px;
    margin-bottom: 5px;
    font-size: 0.95em;
  }
  .provider-info .label {
    color: #888;
    min-width: 65px;
    font-weight: 600;
  }
  .provider-info .value {
    font-weight: 500;
  }
  /* Stars */
  .stars {
    color: #ffbe33;
    font-size: 1.1em;
    user-select: none;
  }
  /* Card Actions */
  .card-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    flex-wrap: wrap;
  }
  .card-actions button {
    flex: 1;
    padding: 8px 10px;
    border: none;
    border-radius: 7px;
    cursor: pointer;
    font-size: 0.95rem;
    color: #fff;
    transition: background 0.15s ease;
  }
  .call {
    background: #2980b9;
  }
  .call:hover {
    background: #1e5a8a;
  }
  .whatsapp {
    background: #25d366;
  }
  .whatsapp:hover {
    background: #1eb955;
  }
  .share {
    background: #ffbe33;
    color: #111;
  }
  .share:hover {
    background: #e1a602;
  }
  .rate {
    background: var(--accent);
  }
  .rate:hover {
    background: #1f9586;
  }
  .delete {
    background: var(--danger);
  }
  .delete:hover {
    background: #9a2d23;
  }
  .edit {
    background: #5e35b1;
  }
  .edit:hover {
    background: #4a2792;
  }
  /* Buttons */
  .show-modal-btn {
    background: var(--primary);
    color: #fff;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 1.05rem;
    border: none;
    cursor: pointer;
    user-select: none;
    transition: background 0.22s ease;
  }
  .show-modal-btn:hover, .submit-btn:hover {
    background: var(--accent);
  }
  .submit-btn {
    background: var(--accent);
    color: #fff;
    padding: 12px 18px;
    border: none;
    border-radius: 10px;
    font-size: 1.1rem;
    cursor: pointer;
    width: 100%;
    margin-top: 10px;
    user-select: none;
    transition: background 0.22s ease;
  }
  .submit-btn:disabled {
    background: #aaa;
    cursor: not-allowed;
  }
  .hidden {
    display: none !important;
  }
  /* Forms */
  form {
    background: #fff;
    padding: 18px 14px;
    max-width: 460px;
    border-radius: 12px;
    box-shadow: 0 4px 20px #0001;
    margin-bottom: 16px;
  }
  body.dark form {
    background: #232834;
    color: #fff;
  }
  input, select, textarea {
    width: 100%;
    padding: 9px 10px;
    margin: 8px 0 6px;
    border: 1.4px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.15s ease;
    background: #fafdff;
    font-family: 'Cairo', sans-serif;
  }
  body.dark input, body.dark select, body.dark textarea {
    background: #222c;
    border-color: #333;
    color: #eee;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--primary);
    outline: none;
  }
  input[readonly] {
    background: #f3f3f3;
    color: #888;
  }
  textarea {
    resize: vertical;
  }
  /* Search bar */
  .searchbar-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 14px;
  }
  .searchbar {
    flex: 1;
    font-size: 1rem;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1.3px solid #bbb;
  }
  .searchbar:focus {
    border-color: var(--primary);
    outline: none;
  }
  /* Toast notifications */
  .toast {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: 25px;
    min-width: 220px;
    background: #111e;
    color: #fff;
    padding: 13px 20px;
    border-radius: 10px;
    box-shadow: 0 4px 16px #0004;
    z-index: 2000;
    font-size: 1.1rem;
    text-align: center;
    animation: toastIn 0.35s cubic-bezier(.21,.6,.38,1.09);
    user-select: none;
  }
  @keyframes toastIn {
    0% {opacity:0; transform:translateY(50px) scale(0.92);}
    100% {opacity:1; transform:translateY(0) scale(1);}
  }
  /* Modal */
  .modal-bg {
    position: fixed;
    inset: 0;
    background: #0007;
    z-index: 3000;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s ease;
  }
  .modal-box {
    background: #fff;
    color: #222;
    border-radius: 14px;
    min-width: 260px;
    max-width: 95vw;
    max-height: 90vh;
    box-shadow: 0 4px 26px #0003;
    position: relative;
    animation: toastIn 0.22s ease;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    direction: rtl;
  }
  .modal-content-scroll {
    overflow-y: auto;
    padding: 20px 20px 12px;
    flex: 1;
  }
  .modal-actions-bottom {
    background: #f7fafd;
    border-top: 1px solid #eee;
    padding: 10px 16px;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    flex-wrap: wrap;
  }
  body.dark .modal-box {
    background: #222c;
    color: #fff;
  }
  body.dark .modal-actions-bottom {
    background: #232834;
    border-top: 1px solid #333;
  }
  .modal-close {
    position: absolute;
    left: 14px;
    top: 12px;
    font-size: 1.6rem;
    color: #999;
    cursor: pointer;
    border: none;
    background: none;
    user-select: none;
  }
  .modal-close:hover {
    color: var(--danger);
  }
  /* Tooltip text */
  .tooltip {
    font-size: 0.92em;
    color: #666;
    margin-bottom: 4px;
  }
  body.dark .tooltip {
    color: #aaa;
  }
  /* Filter row */
  .filter-row {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }
  .filter-row select {
    flex: 1 1 140px;
    min-width: 130px;
  }
  /* Download button */
  .dl-btn {
    background: var(--primary);
    color: #fff;
    padding: 10px 18px;
    border: none;
    border-radius: 9px;
    font-size: 1.03rem;
    cursor: pointer;
    user-select: none;
    transition: background 0.22s ease;
    margin-bottom: 18px;
  }
  .dl-btn:hover {
    background: var(--accent);
  }
  /* Feedback buttons */
  .delete-feedback-btn {
    background: var(--danger);
    color: #fff;
    border: none;
    padding: 5px 12px;
    border-radius: 10px;
    font-size: 1rem;
    cursor: pointer;
    margin-left: 10px;
    user-select: none;
    transition: background 0.22s ease;
  }
  .delete-feedback-btn:hover {
    background: #a72317;
  }
  .add-feedback-btn {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 11px 22px;
    border-radius: 12px;
    font-size: 1.1rem;
    cursor: pointer;
    margin-bottom: 14px;
    user-select: none;
    transition: background 0.22s ease;
    align-self: flex-start;
  }
  .add-feedback-btn:hover {
    background: #1f9586;
  }
  /* Charts Wrap */
.charts-wrap {
  display: flex;
  gap: 12px;
  flex-wrap: nowrap;
  overflow-x: auto;
  padding-bottom: 8px;
  align-items: stretch;
}
.chart-card {
  min-width: 140px;
  max-width: 230px;
  flex: 0 0 auto;
  box-shadow: 0 2px 8px #0001;
  border-radius: 12px;
  background: #fff;
  padding: 8px 5px 8px 5px;
  margin: 0;
  height: 150px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
}
.chart-title {
  font-size: 1em;
  margin-bottom: 2px;
  white-space: nowrap;
}
.canvas-chart {
  max-width: 100% !important;
  max-height: 92px !important;
  margin-top: 2px;
}
@media (max-width: 650px) {
  .charts-wrap {
    gap: 7px;
  }
  .chart-card {
    min-width: 110px;
    max-width: 150px;
    height: 98px;
    padding: 4px 2px;
  }
}
  @media (max-width: 900px) {
    .charts-wrap {
      flex-direction: column;
      gap: 12px;
    }
  }
  @media (max-width: 600px) {
    .modal-box {
      max-width: 95vw;
    }
    .modal-content-scroll {
      padding: 12px 8px 10px;
    }
  }
  @media (max-width: 480px) {
    .main {
      padding: 70px 1rem 10px;
    }
    .modal-box {
      padding: 0;
      border-radius: 0;
      height: 100vh;
      max-height: 100vh;
    }
  }
  /* Admin modal */
  .admin-modal-bg {
    background: #0008;
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3005;
  }
  .admin-modal {
    background: #fff;
    color: #111;
    border-radius: 12px;
    min-width: 220px;
    padding: 22px 18px 16px;
    box-shadow: 0 4px 28px #0002;
    direction: rtl;
    font-size: 1.05rem;
  }
  .admin-modal .pass-input-row {
    display: flex;
    align-items: center;
    margin-bottom: 18px;
    gap: 10px;
  }
  .admin-modal input[type="password"],
  .admin-modal input[type="text"] {
    font-size: 1.12em;
    border: 1.5px solid #eee;
    padding: 8px 10px;
    border-radius: 8px;
    width: 90px;
    text-align: center;
    letter-spacing: 4px;
    font-family: 'Cairo', sans-serif;
  }
  .admin-modal .showhide {
    background: none;
    border: none;
    font-size: 1.4em;
    cursor: pointer;
    color: #444;
    margin-right: 5px;
    user-select: none;
  }
  .admin-error {
    color: var(--danger);
    min-height: 22px;
    font-size: 1em;
    margin-bottom: 6px;
    user-select: none;
  }
.stats-cards {
  display: flex;
  gap: 14px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}
.stat-card {
  background: #fff;
  border-radius: 11px;
  box-shadow: 0 2px 10px #0001;
  padding: 14px 17px;
  font-size: 1.07em;
  min-width: 135px;
  text-align: center;
  font-weight: 600;
  margin-bottom: 6px;
}
body.dark .stat-card { background: #232834; color: #fff; }
.stat-card span { font-size: 1.35em; color: var(--primary); margin-right: 6px; }

.admin-section-card {
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 3px 20px #0001;
  padding: 24px 18px 20px 18px;
  margin-bottom: 24px;
  margin-top: 14px;
  transition: box-shadow 0.18s;
}
body.dark .admin-section-card {
  background: #232834;
  color: #fff;
}
.admin-section-card h3 {
  margin-top: 0;
  font-size: 1.15em;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 18px;
}
body.dark .admin-section-card h3 {
  color: #ffd200;
}
</style>
</head>
<body>
<!-- Brand Bar -->
<header class="brandbar" role="banner" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙˆÙ‚Ø¹">
  <div style="display:flex;align-items:center;gap:10px;">
    <!-- Ø´Ø¹Ø§Ø± ÙÙˆØ±Ø§Ù‹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
    <svg width="40" height="40" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Ø´Ø¹Ø§Ø± ÙÙˆØ±Ø§Ù‹" style="background:#fff;border-radius:50%;box-shadow:0 2px 8px #18456e22;">
      <circle cx="24" cy="24" r="20" fill="#22c1c3"/>
      <path d="M16 28 L24 16 L32 28" stroke="#18456e" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
      <path d="M24 34 L24 22" stroke="#ffd200" stroke-width="3.2" stroke-linecap="round"/>
      <circle cx="24" cy="16" r="3.5" fill="#ffd200"/>
    </svg>
    <span style="font-weight:900;font-size:1.35em;letter-spacing:.5px;">ÙÙˆØ±Ø§Ù‹ - Ù…Ù†ØµØ© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©</span>
  </div>
</header>

  <!-- Hamburger -->
  <button id="hamburger" class="hamburger" aria-label="ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©" aria-expanded="false" aria-controls="sidebarNav" type="button" tabindex="0">
    <div></div><div></div><div></div>
  </button>

  <!-- Sidebar Navigation -->
  <nav id="sidebarNav" class="sidebar" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" role="navigation">
    <h1>ÙÙˆØ±Ø§Ù‹</h1>
    <button data-page="home" type="button">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button data-page="register" type="button">âœï¸ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ù…Ø²ÙˆÙ‘Ø¯ Ø®Ø¯Ù…Ø©</button>
    <button data-page="filter" type="button">ğŸ” Ø¨Ø­Ø« ÙˆÙÙ„ØªØ±Ø©</button>
    <button id="adminBtn" type="button">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
    <button class="toggle-theme" id="themeBtn" type="button" aria-pressed="false">ğŸŒ“ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·</button>
    <button class="add-feedback-btn" id="feedbackBtn" type="button">ğŸ’¬ Ø£Ø¶Ù Ø´ÙƒÙˆÙ‰/Ø§Ù‚ØªØ±Ø§Ø­</button>
  </nav>

  <!-- Overlay for mobile -->
  <div id="navOverlay" class="overlay-nav" tabindex="-1" aria-hidden="true"></div>

  <!-- Toast container -->
  <div id="toastRoot" aria-live="polite" aria-atomic="true"></div>

  <!-- Modal container -->
  <div id="modalRoot" aria-live="assertive" aria-atomic="true" class="hidden"></div>

  <!-- Main Content -->
  <main id="mainContent" class="main" role="main" tabindex="0" aria-label="Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"></main>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
"use strict";

// â­ Local Analytics â€“ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ localStorage
const _analytics = JSON.parse(localStorage.getItem('analytics') || '{}');
function recordEvent(name) {
  _analytics[name] = (_analytics[name] || 0) + 1;
  localStorage.setItem('analytics', JSON.stringify(_analytics));
}

// --- Constants & Globals ---
const ADMIN_PASS = "12345";
const STORAGE_KEYS = {
  providers: "foran_providers",
  requests: "foran_requests",
  feedbacks: "foran_feedbacks",
  ratings: "foran_ratings",
};

let providers = JSON.parse(localStorage.getItem(STORAGE_KEYS.providers) || "[]");
let requests  = JSON.parse(localStorage.getItem(STORAGE_KEYS.requests)  || "[]");
let feedbacks = JSON.parse(localStorage.getItem(STORAGE_KEYS.feedbacks) || "[]");
let ratings   = JSON.parse(localStorage.getItem(STORAGE_KEYS.ratings)   || "{}");
let adminActive = sessionStorage.getItem("admin") === "on";

function getAvgRating(id, manual) {
  if (typeof manual === "number" && manual > 0) return manual;
  if (!ratings[id] || ratings[id].length === 0) return 0;
  const sum = ratings[id].reduce((a, b) => a + b, 0);
  return Math.round((sum / ratings[id].length) * 10) / 10;
}

const sections = [
  {id:"handmade", name:"Ø§Ù„Ø£Ø´ØºØ§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠØ©", emoji:"ğŸ› ï¸", sub:[
    {id:"carpenter", label:"Ù†Ø¬Ø§Ø±/Ù†Ø¬Ø§Ø±Ø©", emojiM:"ğŸ‘¨â€ğŸ”§", emojiF:"ğŸ‘©â€ğŸ”§"},
    {id:"plumber", label:"Ø³Ø¨Ø§Ùƒ/Ø³Ø¨Ø§ÙƒØ©", emojiM:"ğŸ‘¨â€ğŸ”§", emojiF:"ğŸ‘©â€ğŸ”§"},
    {id:"electrician", label:"ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ/ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©", emojiM:"ğŸ‘¨â€ğŸ”§", emojiF:"ğŸ‘©â€ğŸ”§"},
    {id:"blacksmith", label:"Ø­Ø¯Ø§Ø¯/Ø­Ø¯Ø§Ø¯Ø©", emojiM:"ğŸ‘¨â€ğŸ­", emojiF:"ğŸ‘©â€ğŸ­"}
  ]},
  {id:"equipment", name:"Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙˆØ§Ù„Ø¢Ù„ÙŠØ§Øª", emoji:"ğŸšœ", sub:[
    {id:"shovel", label:"Ø´ÙŠÙˆÙ„", emojiM:"ğŸ‘·â€â™‚ï¸", emojiF:"ğŸ‘·â€â™€ï¸"},
    {id:"excavator", label:"Ø­ÙØ§Ø±", emojiM:"ğŸ‘·â€â™‚ï¸", emojiF:"ğŸ‘·â€â™€ï¸"},
    {id:"crane", label:"Ø±Ø§ÙØ¹Ø©", emojiM:"ğŸ‘·â€â™‚ï¸", emojiF:"ğŸ‘·â€â™€ï¸"},
    {id:"compactor", label:"Ø¶Ø§ØºØ·Ø©", emojiM:"ğŸ‘·â€â™‚ï¸", emojiF:"ğŸ‘·â€â™€ï¸"}
  ]},
  {id:"home", name:"Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©", emoji:"ğŸ¡", sub:[
    {id:"ac", label:"Ù…ÙƒÙŠÙ‘ÙØ§Øª", emojiM:"ğŸ§‘â€ğŸ”§", emojiF:"ğŸ§‘â€ğŸ”§"},
    {id:"pest", label:"Ù…ÙƒØ§ÙØ­Ø© Ø­Ø´Ø±Ø§Øª", emojiM:"ğŸ§‘â€ğŸ”§", emojiF:"ğŸ§‘â€ğŸ”§"},
    {id:"clean", label:"ØªÙ†Ø¸ÙŠÙ", emojiM:"ğŸ§‘â€ğŸ¦°", emojiF:"ğŸ§‘â€ğŸ¦°"}
  ]},
  {id:"creative", name:"Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ÙŠØ© ÙˆØ§Ù„ÙÙ†ÙŠØ©", emoji:"ğŸ¨", sub:[
    {id:"decor", label:"Ø¯ÙŠÙƒÙˆØ±", emojiM:"ğŸ‘¨â€ğŸ¨", emojiF:"ğŸ‘©â€ğŸ¨"},
    {id:"painting", label:"Ù†Ù‚Ø§Ø´Ø©", emojiM:"ğŸ‘¨â€ğŸ¨", emojiF:"ğŸ‘©â€ğŸ¨"},
    {id:"design", label:"ØªØµÙ…ÙŠÙ… Ø¯Ø§Ø®Ù„ÙŠ", emojiM:"ğŸ‘¨â€ğŸ¨", emojiF:"ğŸ‘©â€ğŸ¨"}
  ]},
  {id:"tech", name:"Ø§Ù„ØªÙ‚Ù†ÙŠØ© ÙˆØ§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª", emoji:"ğŸ’»", sub:[
    {id:"programmer", label:"Ù…Ø¨Ø±Ù…Ø¬/Ù…Ø¨Ø±Ù…Ø¬Ø©", emojiM:"ğŸ‘¨â€ğŸ’»", emojiF:"ğŸ‘©â€ğŸ’»"},
    {id:"consult", label:"Ø§Ø³ØªØ´Ø§Ø±ÙŠ/Ø§Ø³ØªØ´Ø§Ø±ÙŠØ©", emojiM:"ğŸ‘¨â€ğŸ’¼", emojiF:"ğŸ‘©â€ğŸ’¼"},
    {id:"designer", label:"Ù…ØµÙ…Ù…/Ù…ØµÙ…Ù…Ø©", emojiM:"ğŸ‘¨â€ğŸ’»", emojiF:"ğŸ‘©â€ğŸ’»"}
  ]},
  {id:"driving", name:"Ø³ÙŠØ§Ù‚Ø© ÙˆÙ†Ù‚Ù„", emoji:"ğŸš—", sub:[
    {id:"driver", label:"Ø³Ø§Ø¦Ù‚/Ø³Ø§Ø¦Ù‚Ø©", emojiM:"ğŸ‘¨â€âœˆï¸", emojiF:"ğŸ‘©â€âœˆï¸"},
    {id:"truck", label:"Ø³Ø§Ø¦Ù‚ Ø´Ø§Ø­Ù†Ø©", emojiM:"ğŸ‘¨â€âœˆï¸", emojiF:"ğŸ‘©â€âœˆï¸"}
  ]},
  {id:"agri", name:"Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ©", emoji:"ğŸŒ¾", sub:[
    {id:"farmer", label:"Ø¹Ø§Ù…Ù„ Ø²Ø±Ø§Ø¹Ø©/Ù…Ù‡Ù†Ø¯Ø³", emojiM:"ğŸ‘¨â€ğŸŒ¾", emojiF:"ğŸ‘©â€ğŸŒ¾"},
    {id:"worker", label:"Ø®Ø¯Ù…Ø§Øª Ø²Ø±Ø§Ø¹ÙŠØ© Ø¹Ø§Ù…Ø©", emojiM:"ğŸ‘¨â€ğŸŒ¾", emojiF:"ğŸ‘©â€ğŸŒ¾"}
  ]},
  {id:"hospitality", name:"Ø§Ù„Ø¶ÙŠØ§ÙØ© ÙˆØ§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª", emoji:"ğŸ½ï¸", sub:[
    {id:"cook", label:"Ø·Ø¨Ù‘Ø§Ø®/Ø·Ø¨Ù‘Ø§Ø®Ø©", emojiM:"ğŸ‘¨â€ğŸ³", emojiF:"ğŸ‘©â€ğŸ³"},
    {id:"coffee", label:"ØµØ¨Ø§Ø¨ Ù‚Ù‡ÙˆØ©", emojiM:"ğŸ‘¨â€ğŸ³", emojiF:"ğŸ‘©â€ğŸ³"}
  ]},
  {id:"office", name:"Ù…ÙƒØªØ¨ÙŠØ© ÙˆØ¥Ø¯Ø§Ø±ÙŠØ©", emoji:"ğŸ¢", sub:[
    {id:"secretary", label:"Ø³ÙƒØ±ØªØ§Ø±ÙŠØ©", emojiM:"ğŸ‘¨â€ğŸ’¼", emojiF:"ğŸ‘©â€ğŸ’¼"},
    {id:"account", label:"Ù…Ø­Ø§Ø³Ø¨Ø©", emojiM:"ğŸ‘¨â€ğŸ’¼", emojiF:"ğŸ‘©â€ğŸ’¼"},
    {id:"translate", label:"ØªØ±Ø¬Ù…Ø©", emojiM:"ğŸ‘¨â€ğŸ’¼", emojiF:"ğŸ‘©â€ğŸ’¼"}
  ]}
];

// --- Utility functions ---
function b64e(str) { try { return btoa(unescape(encodeURIComponent(str))); } catch { return str; } }
function b64d(str) { try { return decodeURIComponent(escape(atob(str))); } catch { return str || ""; } }
function saveData() {
  localStorage.setItem(STORAGE_KEYS.providers, JSON.stringify(providers));
  localStorage.setItem(STORAGE_KEYS.requests, JSON.stringify(requests));
  localStorage.setItem(STORAGE_KEYS.feedbacks, JSON.stringify(feedbacks));
  localStorage.setItem(STORAGE_KEYS.ratings, JSON.stringify(ratings));
}
function toast(msg) {
  const toastRoot = document.getElementById("toastRoot");
  const t = document.createElement("div");
  t.className = "toast";
  t.textContent = msg;
  toastRoot.appendChild(t);
  setTimeout(() => t.remove(), 2800);
}

// --- Sidebar & Hamburger ---
const sidebar = document.getElementById("sidebarNav");
const hamburger = document.getElementById("hamburger");
const overlay = document.getElementById("navOverlay");
const main = document.getElementById("mainContent");

function isMobileView() { return window.innerWidth <= 900; }
function toggleSidebar(forceClose = false) {
  if (!isMobileView()) return;
  const isActive = sidebar.classList.contains("active");
  if (forceClose || isActive) {
    sidebar.classList.remove("active");
    overlay.classList.remove("active");
    hamburger.classList.remove("active");
    hamburger.setAttribute("aria-expanded", "false");
    overlay.setAttribute("aria-hidden", "true");
  } else {
    sidebar.classList.add("active");
    overlay.classList.add("active");
    hamburger.classList.add("active");
    hamburger.setAttribute("aria-expanded", "true");
    overlay.setAttribute("aria-hidden", "false");
  }
}
hamburger.addEventListener("click", () => toggleSidebar());
overlay.addEventListener("click", () => toggleSidebar(true));
window.addEventListener("resize", () => {
  if (!isMobileView()) {
    sidebar.classList.remove("active");
    overlay.classList.remove("active");
    hamburger.classList.remove("active");
    hamburger.setAttribute("aria-expanded", "false");
    overlay.setAttribute("aria-hidden", "true");
  }
});

// --- Navigation ---
function setActiveSidebarBtn(pageId) {
  sidebar.querySelectorAll("button[data-page]").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.page === pageId);
  });
}

function navigate(page, subId = null) {
  toggleSidebar(true);
  window.scrollTo(0,0);

  if (!page) page = "home";
  if (page !== "admin" && !adminActive) sessionStorage.removeItem("admin");

  switch(page) {
    case "home": setActiveSidebarBtn("home"); renderSections(); break;
    case "section": if(subId) { setActiveSidebarBtn(null); renderSectionProviders(subId); } break;
    case "filter": setActiveSidebarBtn("filter"); renderFilter(); break;
    case "register": setActiveSidebarBtn("register"); renderRegister(); break;
    case "admin": if(adminActive) { setActiveSidebarBtn(null); renderAdmin(); } else { adminLogin(); } break;
    default: setActiveSidebarBtn("home"); renderSections(); break;
  }
}

function renderSections() {
  main.innerHTML = `
    <h2>ğŸ—‚ï¸ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø®Ø¯Ù…Ø§Øª</h2>
    <div class="card-grid" role="list">
      ${sections.map(s => `
        <div class="section-card" tabindex="0" role="listitem" aria-label="${s.name}"
          onclick="navigate('section', '${s.id}')" onkeydown="if(event.key==='Enter')navigate('section', '${s.id}')">
          <div class="section-emoji">${s.emoji}</div>
          <div>${s.name}</div>
        </div>
      `).join("")}
    </div>
  `;
}

// Providers list in a section (only approved)
function renderSectionProviders(sectionId) {
  const section = sections.find(s => s.id === sectionId);
  if (!section) {
    main.innerHTML = `<p style="color:#a00; padding:20px;">Ø§Ù„Ù‚Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!</p>`;
    return;
  }
  // Filter only approved providers (not in requests)
  const filteredProviders = providers.filter(p => p.section === sectionId);

  main.innerHTML = `
    <button class="show-modal-btn" style="float:left; margin-top:-6px;" onclick="navigate('home')">â¬…ï¸ Ø¹ÙˆØ¯Ø©</button>
    <h2>${section.emoji} ${section.name}</h2>
    <div class="searchbar-wrap" style="margin-top:18px;">
      <input id="searchBar" class="searchbar" type="search" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…..." aria-label="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø³Ù…" autofocus>
      <button class="show-modal-btn" onclick="navigate('register')">+ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ù…Ø²ÙˆÙ‘Ø¯ Ø®Ø¯Ù…Ø©</button>
    </div>
    <div id="providerList"></div>
  `;

  const searchBar = document.getElementById("searchBar");
  searchBar.addEventListener("input", () => {
    const query = searchBar.value.trim().toLowerCase();
    const filtered = filteredProviders.filter(p => {
      const sec = sections.find(s => s.id === p.section) || {};
      return p.name.toLowerCase().includes(query)
        || (sec.name || "").toLowerCase().includes(query)
        || (p.bio || "").toLowerCase().includes(query);
    });
    renderProviders("providerList", filtered);
  });

  renderProviders("providerList", filteredProviders);
}

function renderProviders(containerId, list) {
  const container = document.getElementById(containerId);
  if (!container) return;

  container.innerHTML = "";
  if (list.length === 0) {
    container.innerHTML = `<p style="color:#999; padding: 15px 10px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø²ÙˆÙ‘Ø¯Ùˆ Ø®Ø¯Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>`;
    return;
  }

  list.forEach(p => {
    const sec = sections.find(s => s.id === p.section) || {};
    const sub = (sec.sub || []).find(x => x.id === p.sub) || {};
    const emoji = p.gender === "F" ? (sub.emojiF || sec.emoji) : (sub.emojiM || sec.emoji);
    const avgRating = getAvgRating(p.id, p.rating);
container.insertAdjacentHTML("beforeend", `
  <article class="provider-card" tabindex="0" aria-label="Ù…Ø²ÙˆØ¯ Ø®Ø¯Ù…Ø©: ${p.name}">
    <div class="provider-emoji">${emoji}</div>
    <div class="provider-info">
      <div style="font-size:1.08em; font-weight:700;">${p.name}</div>
      <div class="row"><span class="label">Ø§Ù„Ø¬Ù†Ø³ÙŠØ©:</span><span class="value">${p.nationality}</span></div>
      <div class="row"><span class="label">Ø§Ù„Ù‚Ø³Ù…:</span><span class="value">${sec.name || "-"}</span></div>
      <div class="row"><span class="label">Ø§Ù„ØªØ®ØµØµ:</span><span class="value">${sub.label || "-"}</span></div>
      <div class="row"><span class="label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</span><span class="value">${p.location}</span></div>
      <div class="row"><span class="label">Ø§Ù„Ø®Ø¨Ø±Ø©:</span><span class="value">${(p.bio||"-")}</span></div>
      <div class="row"><span class="label">Ø§Ù„ØªÙˆÙØ±:</span><span class="value">${(p.availability||[]).join("ØŒ ") || "-"}</span></div>
      <div class="row"><span class="stars" title="Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…">${renderStars(avgRating)}</span></div>
      <div class="card-actions" role="group" aria-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø²ÙˆØ¯">
        <button class="call" aria-label="Ø§ØªØµØ§Ù„ ${p.name}" type="button" onclick="window.location.href='tel:${b64d(p.phone)}'">ğŸ“ Ø§ØªØµØ§Ù„</button>
        <button class="whatsapp" aria-label="ÙˆØ§ØªØ³Ø§Ø¨ ${p.name}" type="button"
          onclick="openWhatsApp('${b64d(p.phone)}','${p.name}','${sub.label || "-"}','${(p.availability||[]).join("ØŒ ") || "-"}')">
          ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨
        </button>
            <button class="share" aria-label="Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø·Ø§Ù‚Ø© ${p.name}" type="button" onclick="shareProvider('${p.id}')">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
          </div>
        </div>
      </article>
    `);
  });
}

function renderStars(val) {
  const rounded = Math.round(val);
  let starsHTML = "";
  for (let i = 1; i <= 5; i++) {
    starsHTML += i <= rounded ? "â˜…" : "â˜†";
  }
  return starsHTML;
}

// --- Filter Page ---
function renderFilter() {
  main.innerHTML = `
    <h2>ğŸ” Ø¨Ø­Ø« ÙˆÙÙ„ØªØ±Ø© ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
<div class="filter-row">
  <select id="filterSection" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù…">
    <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
    ${sections.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
  </select>
  <select id="filterGender" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³">
    <option value="">Ø§Ù„Ø¬Ù…ÙŠØ¹</option>
    <option value="M">Ø°ÙƒØ±</option>
    <option value="F">Ø£Ù†Ø«Ù‰</option>
  </select>
  <select id="filterLocation" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
    <option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
    ${
      // Ø¬Ù…Ø¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ÙØ±ÙŠØ¯Ø© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ†
      [...new Set(providers.map(p => p.location).filter(Boolean))]
      .sort((a,b)=>a.localeCompare(b,'ar'))
      .map(loc => `<option value="${loc}">${loc}</option>`).join('')
    }
  </select>
  <select id="filterRating" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…">
    <option value="0">ÙƒÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</option>
    <option value="2">2 Ù†Ø¬Ù…Ø©+</option>
    <option value="3">3 Ù†Ø¬ÙˆÙ…+</option>
    <option value="4">4 Ù†Ø¬ÙˆÙ…+</option>
  </select>
</div>
    <button class="submit-btn" id="applyFiltersBtn" type="button">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
    <div id="filteredList" style="margin-top: 18px;"></div>
  `;
  document.getElementById("applyFiltersBtn").addEventListener("click", applyFilters);
  applyFilters();
}
function applyFilters() {
  const s = document.getElementById("filterSection").value;
  const g = document.getElementById("filterGender").value;
  const l = document.getElementById("filterLocation").value; // â­
  const r = parseFloat(document.getElementById("filterRating").value);
  // Apply filters only on approved providers
  const filtered = providers.filter(p =>
    (!s || p.section === s) &&
    (!g || p.gender === g) &&
    (!l || p.location === l) &&   // â­ Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
    (isNaN(r) || getAvgRating(p.id, p.rating) >= r)
  );
  renderProviders("filteredList", filtered);
}

// --- Render Register Form ---
function renderRegister() {
  main.innerHTML = `
    <h2>âœï¸ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ù…Ø²ÙˆÙ‘Ø¯ Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯</h2>
    <form id="registerForm" autocomplete="off" aria-label="Ù†Ù…ÙˆØ°Ø¬ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ù…Ø²ÙˆØ¯ Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯">
      <label class="tooltip" for="name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
      <input id="name" name="name" type="text" required />
      <label class="tooltip" for="nationality">Ø§Ù„Ø¬Ù†Ø³ÙŠØ© *</label>
      <input id="nationality" name="nationality" type="text" required />
      <label class="tooltip" for="gender">Ø§Ù„Ø¬Ù†Ø³ *</label>
      <select id="gender" name="gender" required>
        <option value="">Ø§Ø®ØªØ±</option>
        <option value="M">Ø°ÙƒØ±</option>
        <option value="F">Ø£Ù†Ø«Ù‰</option>
      </select>
      <label class="tooltip" for="section">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ *</label>
      <select id="section" name="section" required></select>
      <label class="tooltip" for="sub">Ø§Ù„ØªØ®ØµØµ Ø§Ù„ÙØ±Ø¹ÙŠ *</label>
      <select id="sub" name="sub" required disabled></select>
      <label class="tooltip" for="location">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©/Ø§Ù„ÙˆÙ„Ø§ÙŠØ© *</label>
      <input id="location" name="location" type="text" required />
      <label class="tooltip" for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (ÙˆØ§ØªØ³Ø§Ø¨) *</label>
      <input id="phone" name="phone" type="tel" required />
      <label class="tooltip" for="civilid">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ *</label>
      <input id="civilid" name="civilid" type="text" required />
      <label class="tooltip" for="availability">Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØªÙˆÙØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
      <select id="availability" name="availability" multiple style="height:95px;">
        <option value="ØµØ¨Ø§Ø­Ø§Ù‹ ÙƒÙ„ ÙŠÙˆÙ…">ØµØ¨Ø§Ø­Ø§Ù‹ ÙƒÙ„ ÙŠÙˆÙ…</option>
        <option value="Ù…Ø³Ø§Ø¡Ù‹ ÙƒÙ„ ÙŠÙˆÙ…">Ù…Ø³Ø§Ø¡Ù‹ ÙƒÙ„ ÙŠÙˆÙ…</option>
        <option value="ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù…">ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù…</option>
        <option value="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
        <option value="ØµØ¨Ø§Ø­ Ø§Ù„Ø¬Ù…Ø¹Ø©">ØµØ¨Ø§Ø­ Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
        <option value="Ù…Ø³Ø§Ø¡ Ø§Ù„Ø¬Ù…Ø¹Ø©">Ù…Ø³Ø§Ø¡ Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
        <option value="Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</option>
        <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
        <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
        <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
        <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
        <option value="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
        <option value="Ø§Ù„Ø³Ø¨Øª">Ø§Ù„Ø³Ø¨Øª</option>
      </select>
      <label class="tooltip" for="bio">Ø§Ù„Ø®Ø¨Ø±Ø© Ø£Ùˆ Ù†Ø¨Ø°Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <textarea id="bio" name="bio" rows="3"></textarea>
      <button class="submit-btn" type="submit">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
    </form>
  `;
  // Populate Ø§Ù„Ù‚Ø³Ù…
  const sectionSelect = document.getElementById("section");
  const subSelect = document.getElementById("sub");
  sectionSelect.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>` +
    sections.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
  subSelect.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹</option>`;
  subSelect.disabled = true;
  sectionSelect.addEventListener("change", () => {
    const selected = sections.find(s => s.id === sectionSelect.value);
    if (selected) {
      subSelect.innerHTML = selected.sub.map(ss => `<option value="${ss.id}">${ss.label}</option>`).join("");
      subSelect.disabled = false;
    } else {
      subSelect.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹</option>`;
      subSelect.disabled = true;
    }
  });
  // Handle submit
  document.getElementById("registerForm").addEventListener("submit", e => {
    e.preventDefault();
    submitRequest();
  });
}

// --- Submit Registration ---
function submitRequest() {
  const name = document.getElementById("name").value.trim();
  const nationality = document.getElementById("nationality").value.trim();
  const gender = document.getElementById("gender").value;
  const section = document.getElementById("section").value;
  const sub = document.getElementById("sub").value;
  const location = document.getElementById("location").value.trim();
  const phoneRaw = document.getElementById("phone").value.trim();
  const civilidRaw = document.getElementById("civilid").value.trim();
  const bio = document.getElementById("bio").value.trim();
  const availability = Array.from(document.getElementById("availability").selectedOptions).map(o=>o.value);

  if (!name || !nationality || !gender || !section || !sub || !location || !phoneRaw || !civilidRaw) {
    toast("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");
    return;
  }
  const existsInProviders = providers.some(p => b64d(p.civilid) === civilidRaw);
  const existsInRequests = requests.some(r => b64d(r.civilid) === civilidRaw);
  if (existsInProviders || existsInRequests) {
    toast("Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„.");
    return;
  }
  const phone = b64e(phoneRaw);
  const civilid = b64e(civilidRaw);
  const newRequest = {
    id: Date.now() + Math.random().toString(36).slice(2,8),
    name, nationality, gender, section, sub, location, phone, civilid, availability, bio,
    rating: 0,
    created: new Date().toISOString(),
    updated: new Date().toISOString()
  };
  requests.push(newRequest);
  saveData();
  toast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ù…Ø²ÙˆÙ‘Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­! Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©.");
  navigate("home");
}

// --- Admin Section ---

function adminLogin() {
  if(document.querySelector(".admin-modal-bg")) return; // prevent multiple
  const modal = document.createElement("div");
  modal.className = "admin-modal-bg";
  modal.setAttribute("role","dialog");
  modal.setAttribute("aria-modal","true");
  modal.innerHTML = `
    <div class="admin-modal">
      <div style="font-weight:700; font-size:1.1rem; margin-bottom: 14px;">Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ</div>
      <div class="admin-error" id="adminErr" aria-live="assertive"></div>
      <div class="pass-input-row">
        <input id="adminPassInput" type="password" maxlength="20" autocomplete="off" autofocus placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²" aria-label="Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ" />
        <button class="showhide" aria-label="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" type="button">ğŸ‘ï¸</button>
      </div>
      <button class="submit-btn" id="adminLoginBtn" type="button">Ø¯Ø®ÙˆÙ„</button>
      <button class="submit-btn" style="background: var(--danger);" type="button" id="adminCancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  `;
  document.body.appendChild(modal);

  modal.querySelector(".showhide").addEventListener("click", () => {
    const passInput = modal.querySelector("#adminPassInput");
    if(passInput.type === "password") {
      passInput.type = "text";
      modal.querySelector(".showhide").textContent = "ğŸš«";
    } else {
      passInput.type = "password";
      modal.querySelector(".showhide").textContent = "ğŸ‘ï¸";
    }
    passInput.focus();
  });

  modal.querySelector("#adminLoginBtn").addEventListener("click", tryAdminLogin);
  modal.querySelector("#adminCancelBtn").addEventListener("click", closeAdminModal);
  modal.querySelector("#adminPassInput").addEventListener("keydown", e => {
    if(e.key === "Enter") tryAdminLogin();
  });

  function tryAdminLogin() {
    const val = modal.querySelector("#adminPassInput").value;
    const errDiv = modal.querySelector("#adminErr");
    if(val === ADMIN_PASS) {
      adminActive = true;
      sessionStorage.setItem("admin", "on");
      closeAdminModal();
      navigate("admin");
    } else {
      errDiv.textContent = "Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­!";
      modal.querySelector("#adminPassInput").value = "";
      modal.querySelector("#adminPassInput").focus();
    }
  }
}
function closeAdminModal() {
  const modal = document.querySelector(".admin-modal-bg");
  if(modal) modal.remove();
}

function renderAdmin() {
  if(!adminActive) {
    main.innerHTML = `<p style="color:#a00; padding:20px;">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.</p>`;
    return;
  }
  main.innerHTML = `
    <h2>âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
    <div class="stats-cards">
      <div class="stat-card">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ† <span id="statProviders"></span></div>
      <div class="stat-card">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± <span id="statRequests"></span></div>
      <div class="stat-card">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ… <span id="statAvgRating"></span></div>
      <div class="stat-card">Ø£Ø´Ù‡Ø± Ø¬Ù†Ø³ÙŠØ© <span id="statTopNat"></span></div>
    </div>

    <div class="admin-section-card" aria-label="Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
      <h3>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (${requests.length})</h3>
      <div id="requestsList"></div>
    </div>

    <div class="admin-section-card" aria-label="Ù…Ø²ÙˆØ¯Ùˆ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙˆÙ†">
      <h3>âœ… Ù…Ø²ÙˆØ¯Ùˆ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙˆÙ† (${providers.length})</h3>
      <input type="text" id="adminSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ØªØ®ØµØµ Ø£Ùˆ Ø§Ù„Ø¬Ù†Ø³ÙŠØ©" aria-label="Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ†" style="width:100%; padding:10px; border-radius:8px; border:1.5px solid #bbb; font-size:1rem; margin: 15px 0;" />
      <section id="adminList" aria-live="polite" aria-atomic="true"></section>
      <div style="margin-top:18px;">
        <button class="dl-btn" type="button" id="downloadDataBtn">ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (CSV)</button>
        <button class="dl-btn" type="button" id="downloadPdfBtn">ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (PDF)</button>
      </div>
    </div>

    <div class="admin-section-card" aria-label="ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…">
      <h3>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ†</h3>
      <div class="charts-wrap">
        <div class="chart-card" role="img" aria-label="Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ø¯Ø§Ø¦Ø±ÙŠ Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…">
          <div class="chart-title">ØªÙˆØ²ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…</div>
          <canvas id="pieSection" class="canvas-chart" width="200" height="140"></canvas>
        </div>
        <div class="chart-card" role="img" aria-label="Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ø£Ø¹Ù…Ø¯Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù†Ø³ÙŠØ©">
          <div class="chart-title">Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</div>
          <canvas id="barNationality" class="canvas-chart" width="220" height="160"></canvas>
        </div>
      </div>
    </div>

    <div class="admin-section-card" aria-label="Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
      <h3>ğŸ’¡ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
      <button class="add-feedback-btn" type="button" id="addFeedbackAdminBtn">+ Ø¥Ø¶Ø§ÙØ© Ø´ÙƒÙˆÙ‰/Ø§Ù‚ØªØ±Ø§Ø­</button>
      <section id="feedbackList" aria-live="polite" aria-atomic="true" style="margin-top:12px;"></section>
    </div>
  `;
  updateStatsCards();
  document.getElementById("adminSearch").addEventListener("input", renderAdminLists);
  document.getElementById("downloadDataBtn").addEventListener("click", downloadAllData);
  document.getElementById("downloadPdfBtn").addEventListener("click", downloadAllDataPdf);
  document.getElementById("addFeedbackAdminBtn").addEventListener("click", showFeedbackModal);

  renderRequests();
  renderAdminLists();
  renderFeedbacks();
  setTimeout(drawCharts, 120);
}

// Render pending requests list
function renderRequests() {
  const container = document.getElementById("requestsList");
  if (!container) return;
  if (requests.length === 0) {
    container.innerHTML = `<p style="padding:12px; color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯Ø©.</p>`;
    return;
  }
  container.innerHTML = "";

  // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¨Ø¯Ø£ Ù‡Ù†Ø§ ---
  const sortedRequests = [...requests].sort(
    (a, b) => new Date(b.updated || b.created) - new Date(a.updated || a.created)
  );
  sortedRequests.forEach((r, i) => {
    const sec = sections.find(s => s.id === r.section) || {};
    const sub = (sec.sub || []).find(x => x.id === r.sub) || {};
    container.insertAdjacentHTML("beforeend", `
      <article class="provider-card" tabindex="0" aria-label="Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ù…Ø²ÙˆØ¯ Ø®Ø¯Ù…Ø©: ${r.name}">
        <div class="provider-emoji">${r.gender === "F" ? (sub.emojiF || sec.emoji) : (sub.emojiM || sec.emoji)}</div>
        <div class="provider-info">
          <div style="font-size:1.06em; font-weight:700;">${r.name}</div>
          <div class="row"><span class="label">Ø§Ù„Ø¬Ù†Ø³ÙŠØ©:</span><span class="value">${r.nationality}</span></div>
          <div class="row"><span class="label">Ø§Ù„Ù‚Ø³Ù…:</span><span class="value">${sec.name || "-"}</span></div>
          <div class="row"><span class="label">Ø§Ù„ØªØ®ØµØµ:</span><span class="value">${sub.label || "-"}</span></div>
          <div class="row"><span class="label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</span><span class="value">${r.location}</span></div>
          <div class="card-actions" role="group" aria-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø·Ù„Ø¨">
            <button class="rate" type="button" aria-label="Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨" onclick="approveRequest(${i})">âœ”ï¸ Ù‚Ø¨ÙˆÙ„</button>
            <button class="delete" type="button" aria-label="Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨" onclick="rejectRequest(${i})">âœ– Ø±ÙØ¶</button>
          </div>
        </div>
      </article>
    `);
  });
}

// Approve a request, moves to providers list
function approveRequest(idx) {
  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù‚Ø¨ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;
  const r = requests.splice(idx,1)[0];
  providers.push(r);
  saveData();
  toast("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ†");
  renderRequests();
  renderAdminLists();
  drawCharts();
}

// Reject a request (delete)
function rejectRequest(idx) {
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±ÙØ¶ ÙˆØ­Ø°Ù Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŸ")) return;
  requests.splice(idx,1);
  saveData();
  toast("ØªÙ… Ø±ÙØ¶ ÙˆØ­Ø°Ù Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„");
  renderRequests();
}

// Render admin provider list filtered by search
function renderAdminLists() {
  const container = document.getElementById("adminList");
  if (!container) return;
  const query = (document.getElementById("adminSearch")?.value || "").trim().toLowerCase();
  const filtered = providers.filter(p => {
    const secName = (sections.find(s => s.id === p.section) || {}).name || "";
    return p.name.toLowerCase().includes(query) || 
           p.nationality.toLowerCase().includes(query) ||
           secName.toLowerCase().includes(query) ||
           (p.bio || "").toLowerCase().includes(query) ||
           (b64d(p.civilid) || "").includes(query); // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
  });

  if(filtered.length === 0) {
    container.innerHTML = `<p style="padding:12px; color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.</p>`;
    return;
  }
  container.innerHTML = "";

  // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¨Ø¯Ø£ Ù‡Ù†Ø§ ---
  const sortedProviders = [...filtered].sort(
    (a, b) => new Date(b.updated || b.created) - new Date(a.updated || a.created)
  );
  sortedProviders.forEach((p,i) => {
    const sec = sections.find(s => s.id === p.section) || {};
    const sub = (sec.sub || []).find(x => x.id === p.sub) || {};
    const emoji = p.gender === "F" ? (sub.emojiF || sec.emoji) : (sub.emojiM || sec.emoji);
    container.insertAdjacentHTML("beforeend", `
      <article class="provider-card" tabindex="0" aria-label="Ù…Ø²ÙˆØ¯ Ø®Ø¯Ù…Ø©: ${p.name}">
        <div class="provider-emoji">${emoji}</div>
        <div class="provider-info">
          <div style="font-size:1.06em;font-weight:700;">${p.name}</div>
          <div class="row"><span class="label">Ø§Ù„Ø¬Ù†Ø³ÙŠØ©:</span><span class="value">${p.nationality}</span></div>
          <div class="row"><span class="label">Ø§Ù„Ù‚Ø³Ù…:</span><span class="value">${sec.name || "-"}</span></div>
          <div class="row"><span class="label">Ø§Ù„ØªØ®ØµØµ:</span><span class="value">${sub.label || "-"}</span></div>
          <div class="row"><span class="label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</span><span class="value">${p.location}</span></div>
          <div class="row"><span class="label">Ø§Ù„Ø®Ø¨Ø±Ø©:</span><span class="value">${(p.bio||"-")}</span></div>
          <div class="row" style="font-size:0.82em;color:#999;">
            Ø£Ø¶ÙŠÙ ÙÙŠ: ${(p.created || "---").split("T")[0]} | Ø¹Ø¯Ù‘Ù„ ÙÙŠ: ${(p.updated || "---").split("T")[0]}
          </div>
          <div class="card-actions" role="group" aria-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø²ÙˆØ¯">
            <button class="edit" type="button" aria-label="ØªØ¹Ø¯ÙŠÙ„ ${p.name}" onclick="openEditModal(${i})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="rate" type="button" aria-label="ØªÙ‚ÙŠÙŠÙ… ${p.name}" onclick="openRatingModal('${p.id}')">â­ ØªÙ‚ÙŠÙŠÙ…</button>
            <button class="delete" type="button" aria-label="Ø­Ø°Ù ${p.name}" onclick="deleteProvider(${i})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
      </article>
    `);
  });
  // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠÙ†ØªÙ‡ÙŠ Ù‡Ù†Ø§ ---
}

// Delete a provider
function deleteProvider(idx) {
  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø²ÙˆØ¯ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.")) return;
  providers.splice(idx,1);
  saveData();
  toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø²ÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­.");
  renderAdminLists();
  drawCharts();
}

// Open modal to edit provider details
function openEditModal(idx) {
  const p = providers[idx];
  if(!p) return;
  openModal({
    title: "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø²ÙˆØ¯",
    content: `
      <form id="editForm" aria-label="Ù†Ù…ÙˆØ°Ø¬ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø²ÙˆØ¯">
        <label for="editName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
        <input id="editName" name="editName" type="text" required value="${p.name}" />
        <label for="editNationality">Ø§Ù„Ø¬Ù†Ø³ÙŠØ© *</label>
        <input id="editNationality" name="editNationality" type="text" required value="${p.nationality}" />
        <label for="editGender">Ø§Ù„Ø¬Ù†Ø³ *</label>
        <select id="editGender" name="editGender" required>
          <option value="M" ${p.gender==="M"?"selected":""}>Ø°ÙƒØ±</option>
          <option value="F" ${p.gender==="F"?"selected":""}>Ø£Ù†Ø«Ù‰</option>
        </select>
        <label for="editSection">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ *</label>
        <select id="editSection" name="editSection" required></select>
        <label for="editSub">Ø§Ù„ØªØ®ØµØµ Ø§Ù„ÙØ±Ø¹ÙŠ *</label>
        <select id="editSub" name="editSub" required disabled></select>
        <label for="editLocation">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© *</label>
        <input id="editLocation" name="editLocation" type="text" required value="${p.location}" />
        <label for="editPhone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (ÙˆØ§ØªØ³Ø§Ø¨) *</label>
        <input id="editPhone" name="editPhone" type="tel" required value="${b64d(p.phone)}" />
        <label for="editCivilid">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ *</label>
        <input id="editCivilid" name="editCivilid" type="text" required value="${b64d(p.civilid)||""}" />
        <label for="editAvailability">Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØªÙˆÙØ±:</label>
        <select id="editAvailability" name="editAvailability" multiple style="height:95px;">
          <option value="ØµØ¨Ø§Ø­Ø§Ù‹ ÙƒÙ„ ÙŠÙˆÙ…">ØµØ¨Ø§Ø­Ø§Ù‹ ÙƒÙ„ ÙŠÙˆÙ…</option>
          <option value="Ù…Ø³Ø§Ø¡Ù‹ ÙƒÙ„ ÙŠÙˆÙ…">Ù…Ø³Ø§Ø¡Ù‹ ÙƒÙ„ ÙŠÙˆÙ…</option>
          <option value="ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù…">ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù…</option>
          <option value="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
          <option value="ØµØ¨Ø§Ø­ Ø§Ù„Ø¬Ù…Ø¹Ø©">ØµØ¨Ø§Ø­ Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
          <option value="Ù…Ø³Ø§Ø¡ Ø§Ù„Ø¬Ù…Ø¹Ø©">Ù…Ø³Ø§Ø¡ Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
          <option value="Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</option>
          <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
          <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
          <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
          <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
          <option value="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
          <option value="Ø§Ù„Ø³Ø¨Øª">Ø§Ù„Ø³Ø¨Øª</option>
        </select>
        <label for="editBio">Ø§Ù„Ø®Ø¨Ø±Ø© Ø£Ùˆ Ù†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„Ø®Ø¯Ù…Ø©</label>
        <textarea id="editBio" name="editBio" rows="3">${p.bio || ""}</textarea>
        <button class="submit-btn" type="submit">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
      </form>
    `,
    onShow(modalEl) {
      // Fill sections
      const secSelect = modalEl.querySelector("#editSection");
      const subSelect = modalEl.querySelector("#editSub");
      secSelect.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>` + sections.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
      secSelect.value = p.section;
      updateEditSubOptions();
      secSelect.addEventListener("change", updateEditSubOptions);
      function updateEditSubOptions() {
        const selectedSec = sections.find(s => s.id === secSelect.value);
        if(selectedSec) {
          subSelect.innerHTML = selectedSec.sub.map(ss => `<option value="${ss.id}">${ss.label}</option>`).join("");
          subSelect.disabled = false;
          subSelect.value = p.sub;
        } else {
          subSelect.innerHTML = "<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹</option>";
          subSelect.disabled = true;
        }
      }
      // Ø­Ø¯Ø¯ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØªÙˆÙØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø³Ø§Ø¨Ù‚Ù‹Ø§
      const avSel = modalEl.querySelector("#editAvailability");
      if(Array.isArray(p.availability)) {
        [...avSel.options].forEach(opt => { if(p.availability.includes(opt.value)) opt.selected = true; });
      }
      // Handle form submission
      modalEl.querySelector("#editForm").addEventListener("submit", e => {
        e.preventDefault();
        const name = modalEl.querySelector("#editName").value.trim();
        const nationality = modalEl.querySelector("#editNationality").value.trim();
        const gender = modalEl.querySelector("#editGender").value;
        const section = modalEl.querySelector("#editSection").value;
        const sub = modalEl.querySelector("#editSub").value;
        const location = modalEl.querySelector("#editLocation").value.trim();
        const phone = modalEl.querySelector("#editPhone").value.trim();
        const civilid = modalEl.querySelector("#editCivilid").value.trim();
        const availability = Array.from(modalEl.querySelector("#editAvailability").selectedOptions).map(o=>o.value);
        const bio = modalEl.querySelector("#editBio").value.trim();
        if(!name || !nationality || !gender || !section || !sub || !location || !phone || !civilid) {
          alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.");
          return;
        }
        p.name = name;
        p.nationality = nationality;
        p.gender = gender;
        p.section = section;
        p.sub = sub;
        p.location = location;
        p.phone = b64e(phone);
        p.civilid = b64e(civilid);
        p.availability = availability;
        p.bio = bio;
        p.updated = new Date().toISOString();
        saveData();
        toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª.");
        closeModal();
        renderAdminLists();
        drawCharts();
      });
    }
  });
}

// --- ØªØµØ¯ÙŠØ± CSV ---
function downloadAllData() {
  const csvHeaders = [
    "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„Ø¬Ù†Ø³ÙŠØ©", "Ø§Ù„Ø¬Ù†Ø³", "Ø§Ù„Ù‚Ø³Ù…", "Ø§Ù„ØªØ®ØµØµ", "Ø§Ù„Ù…Ù†Ø·Ù‚Ø©", "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ", "Ø§Ù„Ø®Ø¨Ø±Ø©", "Ø§Ù„ØªÙˆÙØ±", "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…"
  ];
  const rows = [csvHeaders.join(",")];
  for(const p of providers) {
    const sec = sections.find(s => s.id === p.section) || {};
    const sub = (sec.sub || []).find(x => x.id === p.sub) || {};
    rows.push([
      p.name,
      p.nationality,
      p.gender === "M" ? "Ø°ÙƒØ±" : "Ø£Ù†Ø«Ù‰",
      sec.name || "-",
      sub.label || "-",
      p.location,
      b64d(p.phone),
      b64d(p.civilid),
      (p.bio||"-").replace(/,/g, "ØŒ"),
      (p.availability||[]).join(";"),
      getAvgRating(p.id, p.rating)
    ].map(x => `"${x}"`).join(","));
  }
  const blob = new Blob([rows.join("\n")], {type: "text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "foran_providers_data.csv";
  a.click();
  URL.revokeObjectURL(a.href);
  toast("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
}

function openRatingModal(providerId) {
  openModal({
    title: "ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø²ÙˆØ¯",
    content: `
      <div>Ø§Ø®ØªØ± ØªÙ‚ÙŠÙŠÙ…Ùƒ Ù„Ù„Ù…Ø²ÙˆØ¯ (1-5 Ù†Ø¬ÙˆÙ…):</div>
      <div style="margin-top: 14px; font-size: 2rem; text-align: center;">
        <button type="button" class="rate-star" data-val="1" aria-label="Ù†Ø¬Ù…Ø© ÙˆØ§Ø­Ø¯Ø©">â˜†</button>
        <button type="button" class="rate-star" data-val="2" aria-label="Ù†Ø¬Ù…ØªØ§Ù†">â˜†</button>
        <button type="button" class="rate-star" data-val="3" aria-label="Ø«Ù„Ø§Ø« Ù†Ø¬ÙˆÙ…">â˜†</button>
        <button type="button" class="rate-star" data-val="4" aria-label="Ø£Ø±Ø¨Ø¹ Ù†Ø¬ÙˆÙ…">â˜†</button>
        <button type="button" class="rate-star" data-val="5" aria-label="Ø®Ù…Ø³ Ù†Ø¬ÙˆÙ…">â˜†</button>
      </div>
    `,
    onShow(modalEl) {
      const stars = [...modalEl.querySelectorAll(".rate-star")];
      let selectedRating = 0;

      function highlightStars(n) {
        stars.forEach((star,i) => star.textContent = i < n ? "â˜…" : "â˜†");
      }

      stars.forEach(star => {
        star.addEventListener("mouseenter", () => highlightStars(parseInt(star.dataset.val)));
        star.addEventListener("mouseleave", () => highlightStars(selectedRating));
        star.addEventListener("click", () => {
          selectedRating = parseInt(star.dataset.val);
          highlightStars(selectedRating);
          submitRating(providerId, selectedRating);
          closeModal();
        });
      });
    }
  });
}

function submitRating(providerId, value) {
  if(!ratings[providerId]) ratings[providerId] = [];
  ratings[providerId].push(value);
  saveData();
  toast("Ø´ÙƒØ±Ù‹Ø§ Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ùƒ!");
  renderAdminLists();
  drawCharts();
}

// --- Sharing ---
function shareProvider(providerId) {
  const p = providers.find(x => x.id === providerId);
  if(!p) return toast("Ø§Ù„Ù…Ø²ÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
  const sec = sections.find(s => s.id === p.section) || {};
  const sub = (sec.sub || []).find(x => x.id === p.sub) || {};
  const phone = b64d(p.phone);
  const siteUrl = "https://foran.om"; // â† Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„ÙØ¹Ù„ÙŠ

  // Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ù…Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø·
  const msg = `ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù…Ø²ÙˆØ¯ Ø®Ø¯Ù…Ø© Ù…ÙˆØ«ÙˆÙ‚ Ø¹Ø¨Ø± Ù…Ù†ØµØ© ÙÙˆØ±Ø§Ù‹:
ğŸ”¹*Ø§Ù„Ø§Ø³Ù…:* ${p.name}
ğŸ”¹*Ø§Ù„Ù‚Ø³Ù…:* ${sec.name}
ğŸ”¹*Ø§Ù„ØªØ®ØµØµ:* ${sub.label}
ğŸ”¹*Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:* ${p.location}
ğŸ”¹*Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„:* ${phone}
ğŸ”¹ *Ø§Ù„Ø®Ø¨Ø±Ø©:* ${(p.bio || "-")}
â­ Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø®Ø¯Ù…Ø§Øª :
${siteUrl}`;

  if(navigator.share) {
    navigator.share({
      title: "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø²ÙˆØ¯ Ø®Ø¯Ù…Ø© Ù…Ù† ÙÙˆØ±Ø§Ù‹",
      text: msg
    }).catch(() => toast("Ù…Ø´Ø§Ø±ÙƒØ© Ù„Ù… ØªØªÙ…"));
  } else {
    // Ù„Ù„Ù†Ø³Ø® Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¹Ø¨Ø± prompt
    prompt("Ø§Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø²ÙˆØ¯ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©:", msg);
  }
}

// --- Feedbacks ---
function renderFeedbacks() {
  const container = document.getElementById("feedbackList");
  if(!container) return;
  if(feedbacks.length === 0) {
    container.innerHTML = `<p style="padding:10px; color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙƒØ§ÙˆÙ‰ Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>`;
    return;
  }
  container.innerHTML = feedbacks.map((f,i) => `
    <article style="background:#f0f9f9; border-radius:10px; padding:12px 14px; margin-bottom:12px;">
      <div><strong>${f.name || "Ù…Ø¬Ù‡ÙˆÙ„"}</strong> - <em>${(f.created || "").split("T")[0]}</em></div>
      <div style="margin-top:8px;">${escapeHtml(f.text)}</div>
      ${adminActive ? `<button class="delete-feedback-btn" type="button" onclick="deleteFeedback(${i})" aria-label="Ø­Ø°Ù Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø£Ùˆ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­">Ø­Ø°Ù</button>` : ""}
    </article>
  `).join("");
}
function escapeHtml(text) {
  return text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function deleteFeedback(idx) {
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø£Ùˆ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ØŸ")) return;
  feedbacks.splice(idx,1);
  saveData();
  toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´ÙƒÙˆÙ‰/Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­.");
  renderFeedbacks();
}
function showFeedbackModal() {
  openModal({
    title: "Ø¥Ø¶Ø§ÙØ© Ø´ÙƒÙˆÙ‰ Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­",
    content: `
      <form id="feedbackForm" aria-label="Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø´ÙƒÙˆÙ‰ Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­">
        <label for="feedbackName">Ø§Ø³Ù…Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="feedbackName" name="feedbackName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯" />
        <label for="feedbackText">Ù†Øµ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø£Ùˆ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ *</label>
        <textarea id="feedbackText" name="feedbackText" rows="4" required aria-required="true" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..."></textarea>
        <button class="submit-btn" type="submit">Ø¥Ø±Ø³Ø§Ù„</button>
      </form>
    `,
    onShow(modalEl) {
      modalEl.querySelector("#feedbackForm").addEventListener("submit", e => {
        e.preventDefault();
        const name = modalEl.querySelector("#feedbackName").value.trim();
        const text = modalEl.querySelector("#feedbackText").value.trim();
        if(!text) {
          alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø£Ùˆ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­.");
          return;
        }
        feedbacks.push({name, text, created: new Date().toISOString()});
        saveData();
        toast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰/Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ØŒ Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ.");
        closeModal();
        renderFeedbacks();
      });
    }
  });
}

// --- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ---
function updateStatsCards() {
  document.getElementById("statProviders").textContent = providers.length;
  document.getElementById("statRequests").textContent = requests.length;
  // Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
  const ratingsArr = Object.values(ratings).flat();
  const avgRating = ratingsArr.length ? (ratingsArr.reduce((a,b)=>a+b,0)/ratingsArr.length).toFixed(2) : "-";
  document.getElementById("statAvgRating").textContent = avgRating;
  // Ø£ÙƒØ«Ø± Ø¬Ù†Ø³ÙŠØ©
  let topNat = "-";
  if (providers.length) {
    const count = {};
    providers.forEach(p => count[p.nationality] = (count[p.nationality]||0)+1);
    topNat = Object.entries(count).sort((a,b)=>b[1]-a[1])[0][0];
  }
  document.getElementById("statTopNat").textContent = topNat;
}

// --- Download all data as CSV ---
function downloadAllData() {
  const csvHeaders = [
    "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„Ø¬Ù†Ø³ÙŠØ©", "Ø§Ù„Ø¬Ù†Ø³", "Ø§Ù„Ù‚Ø³Ù…", "Ø§Ù„ØªØ®ØµØµ", "Ø§Ù„Ù…Ù†Ø·Ù‚Ø©", "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ", "Ø§Ù„Ø®Ø¨Ø±Ø©", "Ø§Ù„ØªÙˆÙØ±", "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…"
  ];
  const rows = [csvHeaders.join(",")];
  for(const p of providers) {
    const sec = sections.find(s => s.id === p.section) || {};
    const sub = (sec.sub || []).find(x => x.id === p.sub) || {};
    rows.push([
      p.name,
      p.nationality,
      p.gender === "M" ? "Ø°ÙƒØ±" : "Ø£Ù†Ø«Ù‰",
      sec.name || "-",
      sub.label || "-",
      p.location,
      b64d(p.phone),
      b64d(p.civilid),
      (p.bio||"-").replace(/,/g, "ØŒ"),
      (p.availability||[]).join(";"),
      getAvgRating(p.id, p.rating)
    ].map(x => `"${x}"`).join(","));
  }
  const blob = new Blob([rows.join("\n")], {type: "text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "foran_providers_data.csv";
  a.click();
  URL.revokeObjectURL(a.href);
  toast("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
}

// --- Modal System ---
const modalRoot = document.getElementById("modalRoot");
let currentModalClose = null;

function openModal({title="", content="", onShow=null}) {
  if(modalRoot.classList.contains("visible")) return; // already open
  modalRoot.innerHTML = `
    <div class="modal-bg" role="dialog" aria-modal="true" aria-labelledby="modalTitle" tabindex="0">
      <div class="modal-box">
        <button class="modal-close" aria-label="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©" type="button">âœ–</button>
        <h3 id="modalTitle" style="margin:12px 0;">${title}</h3>
        <div class="modal-content-scroll">${content}</div>
      </div>
    </div>
  `;
  modalRoot.classList.remove("hidden");
  modalRoot.classList.add("visible");
  const closeBtn = modalRoot.querySelector(".modal-close");
  closeBtn.focus();
  closeBtn.addEventListener("click", closeModal);
  currentModalClose = closeModal;

  if(typeof onShow === "function") onShow(modalRoot.querySelector(".modal-box"));

  // Trap focus inside modal
  trapFocus(modalRoot.querySelector(".modal-bg"));
}

function closeModal() {
  modalRoot.innerHTML = "";
  modalRoot.classList.add("hidden");
  modalRoot.classList.remove("visible");
  currentModalClose = null;
  document.activeElement.blur();
  main.focus();
}

function trapFocus(element) {
  const focusableEls = element.querySelectorAll("a[href],button:not([disabled]),textarea,select,input,[tabindex]:not([tabindex='-1'])");
  const firstFocusableEl = focusableEls[0];
  const lastFocusableEl = focusableEls[focusableEls.length - 1];
  element.addEventListener("keydown", function(e) {
    const isTabPressed = (e.key === 'Tab');
    if (!isTabPressed) return;
    if (e.shiftKey) {
      if(document.activeElement === firstFocusableEl) {
        lastFocusableEl.focus();
        e.preventDefault();
      }
    } else {
      if(document.activeElement === lastFocusableEl) {
        firstFocusableEl.focus();
        e.preventDefault();
      }
    }
  });
}

// --- Charts ---
let pieSectionChart = null;
let barNationalityChart = null;

function drawCharts() {
  // Pie by section
  const ctxPie = document.getElementById("pieSection");
  if (ctxPie) {
    try {
      if (pieSectionChart) pieSectionChart.destroy();
    } catch (e) {}
    const counts = {};
    for (const s of sections) counts[s.name] = 0;
    providers.forEach(p => {
      const secName = (sections.find(s => s.id === p.section) || {}).name;
      if (secName) counts[secName] = (counts[secName] || 0) + 1;
    });
    const labels = Object.keys(counts);
    const data = Object.values(counts);

    pieSectionChart = new Chart(ctxPie, {
      type: 'pie',
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: [
            '#27bda5', '#ffd200', '#ff6f00', '#29b6f6', '#c0392b',
            '#9c27b0', '#43a047', '#ff9800', '#8bc34a', '#f44336'
          ],
          borderColor: '#fff',
          borderWidth: 1.5
        }]
      },
      options: {
        plugins: {
          legend: { position: 'bottom', labels: { font: { family: 'Cairo' } } }
        },
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }

  // Bar by nationality
  const ctxBar = document.getElementById("barNationality");
  if (ctxBar) {
    try {
      if (barNationalityChart) barNationalityChart.destroy();
    } catch (e) {}
    // Ø¹Ø¯Ù‘ Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù†Ø³ÙŠØ©
    const natCounts = {};
    providers.forEach(p => {
      const nat = p.nationality || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
      natCounts[nat] = (natCounts[nat] || 0) + 1;
    });
    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ù†Ø³ÙŠØ§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø¸Ù‡ÙˆØ±Ø§Ù‹
    const sortedNats = Object.entries(natCounts).sort((a, b) => b[1] - a[1]);
    const top7 = sortedNats.slice(0, 7);
    const othersCount = sortedNats.slice(7).reduce((sum, x) => sum + x[1], 0);
    const natLabels = top7.map(x => x[0]).concat(othersCount > 0 ? ["Ø£Ø®Ø±Ù‰"] : []);
    const natData = top7.map(x => x[1]).concat(othersCount > 0 ? [othersCount] : []);

    barNationalityChart = new Chart(ctxBar, {
      type: 'bar',
      data: {
        labels: natLabels,
        datasets: [{
          label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ†',
          data: natData,
          backgroundColor: '#27bda5'
        }]
      },
      options: {
        plugins: {
          legend: { display: false }
        },
        responsive: false, // Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ´Ù†Ø¬ ÙÙŠ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø¶Ø¹ÙŠÙØ©
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { font: { family: 'Cairo' } } },
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 }
          }
        }
      }
    });
  }
}
// --- Dark mode toggle ---
const themeBtn = document.getElementById("themeBtn");
function setDarkMode(dark) {
  if(dark) {
    document.body.classList.add("dark");
    themeBtn.setAttribute("aria-pressed","true");
  } else {
    document.body.classList.remove("dark");
    themeBtn.setAttribute("aria-pressed","false");
  }
}
themeBtn.addEventListener("click", () => {
  const dark = !document.body.classList.contains("dark");
  setDarkMode(dark);
  localStorage.setItem("darkMode", dark ? "on" : "off");
});
(function() {
  const saved = localStorage.getItem("darkMode");
  setDarkMode(saved === "on");
})();

// --- Init ---
document.getElementById("adminBtn").addEventListener("click", () => {
  if(adminActive) navigate("admin");
  else adminLogin();
});
document.getElementById("feedbackBtn").addEventListener("click", showFeedbackModal);

sidebar.querySelectorAll("button[data-page]").forEach(btn => {
  btn.addEventListener("click", () => {
    navigate(btn.dataset.page);
  });
});

navigate("home");

function openWhatsApp(phone, name, subLabel, availability) {
  // ÙŠØ­ÙˆÙ‘Ù„ Ø§Ù„Ø±Ù‚Ù… Ù„ØµÙŠØºØ© Ø¯ÙˆÙ„ÙŠØ© Ù„Ùˆ Ù†Ø§Ù‚Øµ
  phone = phone.replace(/[^\d]/g, "");
  if (phone.startsWith("0")) phone = "968" + phone.slice(1);
  if (!phone.startsWith("968") && phone.length <= 9) phone = "968" + phone;
  const msg = encodeURIComponent(`Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ Ù„Ø¯ÙŠ Ø·Ù„Ø¨ Ø¨Ø®ØµÙˆØµ Ø§Ù„Ø®Ø¯Ù…Ø©. 
- Ø§Ù„Ø§Ø³Ù…: ${name}
- Ø§Ù„ØªØ®ØµØµ: ${subLabel}
- Ø§Ù„ØªÙˆÙØ±: ${availability}`);
  window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
}

function downloadAllDataPdf() {
  // PDF Ø³Ø±ÙŠØ¹ Ø¨Ø¯ÙˆÙ† Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©)
  let html = `
    <html dir="rtl">
    <head>
      <title>Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø²ÙˆØ¯ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©</title>
      <style>
        body { font-family: 'Cairo', Tahoma, Arial, sans-serif; margin: 30px; color: #222; }
        table { border-collapse: collapse; width: 100%; margin-top: 18px; }
        th, td { border: 1px solid #8883; padding: 8px 7px; font-size: 1em; }
        th { background: #18456e; color: #fff; font-size:1.07em;}
        tr:nth-child(even) { background: #f7fafd; }
      </style>
    </head>
    <body>
      <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø²ÙˆØ¯ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©</h2>
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</th>
            <th>Ø§Ù„Ø¬Ù†Ø³</th>
            <th>Ø§Ù„Ù‚Ø³Ù…</th>
            <th>Ø§Ù„ØªØ®ØµØµ</th>
            <th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
            <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ</th>
            <th>Ø§Ù„Ø®Ø¨Ø±Ø©</th>
            <th>Ø§Ù„ØªÙˆÙØ±</th>
            <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
          </tr>
        </thead>
        <tbody>
          ${
            providers.map(p => {
              const sec = sections.find(s => s.id === p.section) || {};
              const sub = (sec.sub || []).find(x => x.id === p.sub) || {};
              return `<tr>
                <td>${p.name}</td>
                <td>${p.nationality}</td>
                <td>${p.gender === "M" ? "Ø°ÙƒØ±" : "Ø£Ù†Ø«Ù‰"}</td>
                <td>${sec.name || "-"}</td>
                <td>${sub.label || "-"}</td>
                <td>${p.location}</td>
                <td>${b64d(p.phone)}</td>
                <td>${b64d(p.civilid)}</td>
                <td>${(p.bio||"-")}</td>
                <td>${(p.availability||[]).join(";")}</td>
                <td>${getAvgRating(p.id, p.rating)}</td>
              </tr>`;
            }).join("")
          }
        </tbody>
      </table>
<script>window.onload = function(){ window.print(); setTimeout(()=>window.close(), 1200); }
    </body>
    </html>
  `;
  const w = window.open("", "_blank");
  w.document.write(html);
  w.document.close();
}

</script>
</script>

<!-- â­ Service Worker (PWA) - Ù…Ø¯Ù…Ø¬ Ù…Ø¹ Ø§Ù„ØµÙØ­Ø© -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    const swCode = `
      const CACHE_NAME = 'foran-cache-v1';
      const URLS_TO_CACHE = [
        location.pathname,
        'https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap'
      ];
      self.addEventListener('install', e => {
        e.waitUntil(
          caches.open(CACHE_NAME)
            .then(cache => cache.addAll(URLS_TO_CACHE))
        );
      });
      self.addEventListener('fetch', e => {
        e.respondWith(
          caches.match(e.request)
            .then(res => res || fetch(e.request))
        );
      });
      self.addEventListener('activate', e => {
        e.waitUntil(
          caches.keys().then(keys =>
            Promise.all(
              keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k))
            )
          )
        );
      });
    `;
    const blob = new Blob([swCode], {type: 'application/javascript'});
    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl).then(function(reg) {
      setTimeout(()=>URL.revokeObjectURL(swUrl), 5000);
    });
  });
}
</script>

<!-- â­ Service Worker (PWA) - ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø¯Ù…Ø¬ Ø¯Ø§Ø®Ù„ index.html -->
<script>
// âœ… ØªØ³Ø¬ÙŠÙ„ ÙˆØªÙˆÙ„ÙŠØ¯ sw.js Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„ØµÙØ­Ø© (Ø¨Ø¯ÙˆÙ† Ù…Ù„ÙØ§Øª Ø®Ø§Ø±Ø¬ÙŠØ©)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    // Ù†Ù†Ø´Ø¦ sw Ù…Ù† Ù†Øµ JS Ù‡Ù†Ø§ (Ø¨Ø¯Ù„ Ù…Ù„Ù Ø®Ø§Ø±Ø¬ÙŠ)
    const swCode = `
      const CACHE_NAME = 'foran-cache-v1';
      const URLS_TO_CACHE = [
        location.pathname, // Ø§Ù„ØµÙØ­Ø© Ù†ÙØ³Ù‡Ø§
        // Ø£Ø¶Ù Ù‡Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© Ù…Ø«Ù„ Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„ØµÙˆØ± Ø§Ù„Ù…Ù‡Ù…Ø© (Ù…Ù† Ù…Ù„ÙÙƒ)
        'https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap'
      ];

      self.addEventListener('install', e => {
        e.waitUntil(
          caches.open(CACHE_NAME)
            .then(cache => cache.addAll(URLS_TO_CACHE))
        );
      });

      self.addEventListener('fetch', e => {
        e.respondWith(
          caches.match(e.request)
            .then(res => res || fetch(e.request))
        );
      });

      self.addEventListener('activate', e => {
        e.waitUntil(
          caches.keys().then(keys =>
            Promise.all(
              keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k))
            )
          )
        );
      });
    `;
    // Ù†Ù†Ø´Ø¦ Ù…Ù„Ù SW Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
    const blob = new Blob([swCode], {type: 'application/javascript'});
    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl).then(function(reg) {
      // Ù…Ø³Ø­ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      setTimeout(()=>URL.revokeObjectURL(swUrl), 5000);
    });
  });
}
</script>

</body>
</html>
